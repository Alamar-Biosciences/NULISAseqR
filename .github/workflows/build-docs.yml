name: ðŸ“š Build Documentation

on:
  workflow_call:
    inputs:
      cname:
        description: 'CNAME for GitHub Pages deployment'
        required: true
        type: string
    secrets:
      UTILITY_ACCESS_TOKEN:
        required: true

env:
  DOCKER_COMPOSE_YML: docker-compose.yml

jobs:
  build-vignette:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download base image artifact
        uses: actions/download-artifact@v4
        with:
          name: base-docker-image
          path: /tmp

      - name: Load Docker image
        run: |
          docker load -i /tmp/base-image.tar

      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose version

      - name: Build vignette
        env:
          DOCKER_BUILDKIT: "0"
          COMPOSE_DOCKER_CLI_BUILD: "0"
        run: |
          echo "Building vignette with Docker..."
          docker-compose -f ${{ env.DOCKER_COMPOSE_YML }} -p nulisaseqr up -d --no-deps --build vignette

          CID=$(docker-compose -f ${{ env.DOCKER_COMPOSE_YML }} -p nulisaseqr ps -q vignette)

          if [ -z "$CID" ]; then
            echo "Could not find container ID for service 'vignette'!"
            docker-compose -f ${{ env.DOCKER_COMPOSE_YML }} -p nulisaseqr ps
            exit 1
          fi
          echo "Vignette container: $CID"

          exit_code=$(docker wait "$CID")

          if [ "$exit_code" -ne 0 ]; then
            echo "Error: Vignette build failed! (exit $exit_code)"
            docker logs "$CID"
            exit 1
          else
            echo "ðŸ“š Vignette built successfully!"
          fi

      - name: Tear down docker-compose
        if: always()
        run: |
          docker-compose -f ${{ env.DOCKER_COMPOSE_YML }} down

      - name: Deploy vignette to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.UTILITY_ACCESS_TOKEN }}
          publish_dir: ./vignettes/book/_book
          destination_dir: user-guide
          cname: ${{ inputs.cname }}
          keep_files: true

  build-pkgdown:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update pkgdown URLs for deployment target
        env:
          CNAME: ${{ inputs.cname }}
        run: |
          sed -i "s|url: https://nulisaseqr.alamarbio.com|url: https://${CNAME}|g" _pkgdown.yml
          sed -i "s|https://nulisaseqr.alamarbio.com/user-guide|https://${CNAME}/user-guide|g" _pkgdown.yml
          echo "Updated _pkgdown.yml URLs to use ${CNAME}"
          grep -E "(url:|href:.*user-guide)" _pkgdown.yml

      - name: Download base image artifact
        uses: actions/download-artifact@v4
        with:
          name: base-docker-image
          path: /tmp

      - name: Load Docker image
        run: |
          docker load -i /tmp/base-image.tar

      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose version

      - name: Build pkgdown site
        env:
          DOCKER_BUILDKIT: "0"
          COMPOSE_DOCKER_CLI_BUILD: "0"
        run: |
          echo "Building pkgdown site with Docker..."
          docker-compose -f ${{ env.DOCKER_COMPOSE_YML }} -p nulisaseqr up -d --no-deps --build pkgdown

          CID=$(docker-compose -f ${{ env.DOCKER_COMPOSE_YML }} -p nulisaseqr ps -q pkgdown)

          if [ -z "$CID" ]; then
            echo "Could not find container ID for service 'pkgdown'!"
            docker-compose -f ${{ env.DOCKER_COMPOSE_YML }} -p nulisaseqr ps
            exit 1
          fi
          echo "Pkgdown container: $CID"

          exit_code=$(docker wait "$CID")

          if [ "$exit_code" -ne 0 ]; then
            echo "Error: Pkgdown build failed! (exit $exit_code)"
            docker logs "$CID"
            exit 1
          else
            echo "ðŸ“– Pkgdown site built successfully!"
          fi

      - name: Tear down docker-compose
        if: always()
        run: |
          docker-compose -f ${{ env.DOCKER_COMPOSE_YML }} down

      - name: Deploy pkgdown to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.UTILITY_ACCESS_TOKEN }}
          publish_dir: ./docs
          cname: ${{ inputs.cname }}
          keep_files: true
